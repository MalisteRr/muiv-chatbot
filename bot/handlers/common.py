"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–±—â–∏—Ö –∫–æ–º–∞–Ω–¥
–î–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""

import logging
from aiogram import Router, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message

from bot.keyboards import get_main_keyboard
from database.crud import get_user_stats, create_or_update_user
from ml.chat_manager import ChatManager
from utils.helpers import format_user_info

logger = logging.getLogger(__name__)
router = Router(name='common')

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —á–∞—Ç–∞
chat_manager = ChatManager()


@router.message(CommandStart())
async def cmd_start(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    user_id = message.from_user.id
    user_name = message.from_user.first_name
    full_name = message.from_user.full_name
    username = message.from_user.username
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    await create_or_update_user(
        user_id=user_id,
        username=username,
        first_name=user_name,
        last_name=message.from_user.last_name,
        role='user'
    )
    
    welcome_text = f"""üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_name}!

–Ø –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ **–ú–£–ò–í** (–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –∏–º –°.–Æ. –í–∏—Ç—Ç–µ).

**–Ø –ø–æ–º–æ–≥—É –≤–∞–º —É–∑–Ω–∞—Ç—å:**
üìö –ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö
üéì –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—é–¥–∂–µ—Ç–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
üè† –£—Å–ª–æ–≤–∏—è –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏
üìù –ö–∞–∫ –ø–æ—Å—Ç—É–ø–∏—Ç—å –±–µ–∑ –ï–ì–≠
üè´ –§–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è (–æ—á–Ω–∞—è, –∑–∞–æ—á–Ω–∞—è, –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–∞—è)

**–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–∑ –º–µ–Ω—é!** üëá

üí° –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å —Å–≤–æ–±–æ–¥–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º - —è –ø–æ–π–º—É –∏ –æ—Ç–≤–µ—á—É!"""
    
    await message.answer(
        welcome_text,
        reply_markup=get_main_keyboard(),
        parse_mode="Markdown"
    )
    
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({full_name}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")


@router.message(Command("help"))
async def cmd_help(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞
    """
    help_text = """ü§ñ **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:**

**1Ô∏è‚É£ –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±:**
–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é —Ç–µ–º—É –∏–∑ –º–µ–Ω—é –∫–Ω–æ–ø–æ–∫ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞

**2Ô∏è‚É£ –£–º–Ω—ã–π —Å–ø–æ—Å–æ–±:**
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º - —è –∏—Å–ø–æ–ª—å–∑—É—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏ –æ—Ç–≤–µ—á—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞!

**–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤:**
‚Ä¢ "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è?"
‚Ä¢ "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ —é—Ä–∏—Å—Ç–∞?"
‚Ä¢ "–ï—Å—Ç—å –ª–∏ –±—é–¥–∂–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –Ω–∞ IT?"
‚Ä¢ "–ú–æ–∂–Ω–æ –ª–∏ –ø–æ—Å—Ç—É–ø–∏—Ç—å –±–µ–∑ –ï–ì–≠?"
‚Ä¢ "–ö–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤?"

**üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
/start - –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/clear - –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
/stats - –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/contacts - –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏

**üéì –û –±–æ—Ç–µ:**
–Ø –∏—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∞—à–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –Ω–∞—Ö–æ–∂—É –æ—Ç–≤–µ—Ç—ã –≤ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –ú–£–ò–í.

**üìû –ù—É–∂–Ω–∞ –ª–∏—á–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è?**
–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π:
‚òéÔ∏è 8 (800) 550-03-63 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
‚òéÔ∏è +7 (495) 500-03-63
‚úâÔ∏è pk@muiv.ru
üåê muiv.ru"""
    
    await message.answer(help_text, parse_mode="Markdown")


@router.message(Command("clear"))
async def cmd_clear(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear
    –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    user_id = message.from_user.id
    
    # –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤ –º–µ–Ω–µ–¥–∂–µ—Ä–µ —á–∞—Ç–∞
    chat_manager.clear_history(user_id)
    
    await message.answer(
        "‚úÖ –ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞!\n\n"
        "–¢–µ–ø–µ—Ä—å —è –Ω–µ –ø–æ–º–Ω—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π. "
        "–ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä.",
        reply_markup=get_main_keyboard()
    )
    
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –æ—á–∏—Å—Ç–∏–ª –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞")


@router.message(Command("stats"))
async def cmd_stats(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stats
    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    """
    user_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –ë–î
    stats = await get_user_stats(user_id)
    
    if not stats:
        await message.answer("üìä –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞.")
        return
    
    stats_text = f"""üìä **–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**

üí¨ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {stats.get('total_messages', 0)}
üìÖ –ü–µ—Ä–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ: {stats.get('first_message', 'N/A')}
üïê –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ: {stats.get('last_message', 'N/A')}
‚úÖ –ù–∞–π–¥–µ–Ω–æ –æ—Ç–≤–µ—Ç–æ–≤: {stats.get('found_answers', 0)}
‚ùì –ù–µ –Ω–∞–π–¥–µ–Ω–æ: {stats.get('not_found', 0)}

**–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:**
{stats.get('top_categories', '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')}

–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞! üòä"""
    
    await message.answer(stats_text, parse_mode="Markdown")


@router.message(Command("contacts"))
async def cmd_contacts(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /contacts
    –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ú–£–ò–í
    """
    contacts_text = """üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ú–£–ò–í:**

**–¢–µ–ª–µ—Ñ–æ–Ω—ã:**
‚òéÔ∏è 8 (800) 550-03-63 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ –†–æ—Å—Å–∏–∏)
‚òéÔ∏è +7 (495) 500-03-63

**Email:**
‚úâÔ∏è pk@muiv.ru

**–ê–¥—Ä–µ—Å:**
üìç –ú–æ—Å–∫–≤–∞, 2-–π –ö–æ–∂—É—Ö–æ–≤—Å–∫–∏–π –ø—Ä–æ–µ–∑–¥, 12, —Å—Ç—Ä.1
‚ìÇÔ∏è –º. "–î—É–±—Ä–æ–≤–∫–∞" (5 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º)

**–°–∞–π—Ç:**
üåê muiv.ru

**–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏:**
–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ß–µ—Ç–≤–µ—Ä–≥: 09:30 - 18:15
–ü—è—Ç–Ω–∏—Ü–∞: 09:30 - 17:00
–°—É–±–±–æ—Ç–∞: 10:00 - 15:00
–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ: –≤—ã—Ö–æ–¥–Ω–æ–π

**–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏:**
üì± VK: vk.com/muiv_official
üì± Telegram: t.me/muiv_official

–ë—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å! üéì"""
    
    await message.answer(contacts_text, parse_mode="Markdown")
    
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–ø—Ä–æ—Å–∏–ª –∫–æ–Ω—Ç–∞–∫—Ç—ã")


@router.message(F.text == "‚ùì –ü–æ–º–æ—â—å")
async def handle_help_button(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ü–æ–º–æ—â—å'"""
    await cmd_help(message)


@router.message(F.text == "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã")
async def handle_contacts_button(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ö–æ–Ω—Ç–∞–∫—Ç—ã'"""
    await cmd_contacts(message)