import asyncio
import logging
import os
import httpx
from dotenv import load_dotenv
from openai import AsyncOpenAI

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import CommandStart, Command
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.fsm.storage.memory import MemoryStorage

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('../logs/bot.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
BASE_URL = os.getenv("OPENAI_BASE_URL", "https://openrouter.ai/api/v1")
MODEL = os.getenv("LLM_MODEL", "deepseek/deepseek-r1")
DATABASE_URL = os.getenv("DATABASE_URL")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(token=TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# OpenRouter –∫–ª–∏–µ–Ω—Ç
openai_client = AsyncOpenAI(
    api_key=OPENAI_KEY,
    base_url=BASE_URL,
    http_client=httpx.AsyncClient()
)

# –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤
chat_history = {}

# ========== FAQ –ë–ê–ó–ê ==========
FAQ_BASE = {
    "–¥–æ–∫—É–º–µ–Ω—Ç—ã": """üìÑ **–î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –Ω–∞ –±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç:**

‚Ä¢ –ü–∞—Å–ø–æ—Ä—Ç (–æ—Ä–∏–≥–∏–Ω–∞–ª –∏–ª–∏ –∫–æ–ø–∏—è)
‚Ä¢ –ê—Ç—Ç–µ—Å—Ç–∞—Ç –æ —Å—Ä–µ–¥–Ω–µ–º –æ–±—â–µ–º –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–∏ –∏–ª–∏ –¥–∏–ø–ª–æ–º –°–ü–û
‚Ä¢ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ï–ì–≠ (–¥–ª—è –≤—ã–ø—É—Å–∫–Ω–∏–∫–æ–≤ 11 –∫–ª–∞—Å—Å–æ–≤)
‚Ä¢ –°–ù–ò–õ–°
‚Ä¢ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ 3x4 (6 —à—Ç—É–∫)
‚Ä¢ –ó–∞—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–∏–µ–º–µ (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∞—á–µ)

**–°–ø–æ—Å–æ–±—ã –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
‚úÖ –õ–∏—á–Ω–æ: –ú–æ—Å–∫–≤–∞, 2-–π –ö–æ–∂—É—Ö–æ–≤—Å–∫–∏–π –ø—Ä-–¥, 12, —Å—Ç—Ä.1, –∫–∞–±. 101
‚úÖ –û–Ω–ª–∞–π–Ω: —á–µ—Ä–µ–∑ –ì–æ—Å—É—Å–ª—É–≥–∏ –∏–ª–∏ —Å–∞–π—Ç muiv.ru
‚úÖ –ü–æ –ø–æ—á—Ç–µ: –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–æ –∑–∞–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–ø–∏–∏

üìû –í–æ–ø—Ä–æ—Å—ã: 8 (800) 550-03-63""",

    "—Å—Ç–æ–∏–º–æ—Å—Ç—å": """üí∞ **–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –≤ –ú–£–ò–í:**

‚Ä¢ **–û—á–Ω–∞—è —Ñ–æ—Ä–º–∞**: –æ—Ç 65 000 –¥–æ 90 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä
‚Ä¢ **–û—á–Ω–æ-–∑–∞–æ—á–Ω–∞—è**: –æ—Ç 55 000 –¥–æ 75 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä
‚Ä¢ **–ó–∞–æ—á–Ω–∞—è**: –æ—Ç 35 000 –¥–æ 50 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä
‚Ä¢ **–î–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–∞—è**: –æ—Ç 30 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä

–°—Ç–æ–∏–º–æ—Å—Ç—å —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É—á–µ–±–Ω—ã–π –≥–æ–¥, –æ–ø–ª–∞—Ç–∞ —Å–µ–º–µ—Å—Ç—Ä–∞–º–∏.

üìû –¢–æ—á–Ω–∞—è —Ü–µ–Ω–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é: 8 (800) 550-03-63
üåê –°–∞–π—Ç: muiv.ru""",

    "–±—é–¥–∂–µ—Ç": """üéì **–ë—é–¥–∂–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ (–ö–¶–ü) –≤ –ú–£–ò–í:**

–î–∞! –ï—Å—Ç—å –±—é–¥–∂–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º:
‚Ä¢ –≠–∫–æ–Ω–æ–º–∏–∫–∞
‚Ä¢ –Æ—Ä–∏—Å–ø—Ä—É–¥–µ–Ω—Ü–∏—è
‚Ä¢ –ú–µ–Ω–µ–¥–∂–º–µ–Ω—Ç
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º
‚Ä¢ –ü—Ä–∏–∫–ª–∞–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞
‚Ä¢ –†–µ–∫–ª–∞–º–∞ –∏ —Å–≤—è–∑–∏ —Å –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ. –ö–æ–Ω–∫—É—Ä—Å –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ï–ì–≠ –∏–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —ç–∫–∑–∞–º–µ–Ω–æ–≤.

üìû –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: 8 (800) 550-03-63""",

    "–æ–±—â–µ–∂–∏—Ç–∏–µ": """üè† **–û–±—â–µ–∂–∏—Ç–∏–µ –≤ –ú–£–ò–í:**

–î–∞! –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–±—â–µ–∂–∏—Ç–∏–µ –¥–ª—è –∏–Ω–æ–≥–æ—Ä–æ–¥–Ω–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.

**–£—Å–ª–æ–≤–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç–∞:**
‚úÖ –£–∫–∞–∑–∞—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –∑–∞—è–≤–ª–µ–Ω–∏–∏ –æ –ø—Ä–∏–µ–º–µ
‚úÖ –ë—ã—Ç—å –∑–∞—á–∏—Å–ª–µ–Ω–Ω—ã–º –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
‚úÖ –ü–æ–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∑–∞—Å–µ–ª–µ–Ω–∏–µ

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ - —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –æ—á–µ—Ä–µ–¥–∏.

üìû –ù–∞–ª–∏—á–∏–µ –º–µ—Å—Ç: +7 (495) 500-03-63
‚úâÔ∏è Email: pk@muiv.ru""",

    "–µ–≥—ç": """üìù **–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –±–µ–∑ –ï–ì–≠:**

–î–∞, –º–æ–∂–Ω–æ –ø–æ—Å—Ç—É–ø–∏—Ç—å –±–µ–∑ –ï–ì–≠!

**–ö—Ç–æ –º–æ–∂–µ—Ç:**
‚Ä¢ –í—ã–ø—É—Å–∫–Ω–∏–∫–∏ –∫–æ–ª–ª–µ–¥–∂–µ–π –∏ —Ç–µ—Ö–Ω–∏–∫—É–º–æ–≤ (–ø–æ—Å–ª–µ –°–ü–û)
‚Ä¢ –ü–æ—Å—Ç—É–ø–∞—é—â–∏–µ –Ω–∞ –≤—Ç–æ—Ä–æ–µ –≤—ã—Å—à–µ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
‚Ä¢ –ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ –≥—Ä–∞–∂–¥–∞–Ω–µ
‚Ä¢ –í—ã–ø—É—Å–∫–Ω–∏–∫–∏ –ø—Ä–æ—à–ª—ã—Ö –ª–µ—Ç –±–µ–∑ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ï–ì–≠

–í—ã —Å–¥–∞–µ—Ç–µ **–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è** –ø–æ –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ.

üìû –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: 8 (800) 550-03-63""",

    "—Ñ–æ—Ä–º—ã": """üè´ **–§–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è –≤ –ú–£–ò–í:**

1Ô∏è‚É£ **–û—á–Ω–∞—è** - 5-6 –¥–Ω–µ–π –≤ –Ω–µ–¥–µ–ª—é, –∑–∞–Ω—è—Ç–∏—è –¥–Ω–µ–º
   ‚Ä¢ –°—Ä–æ–∫: 4 –≥–æ–¥–∞ (–±–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç)
   ‚Ä¢ –û—Ç 65 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä

2Ô∏è‚É£ **–û—á–Ω–æ-–∑–∞–æ—á–Ω–∞—è (–≤–µ—á–µ—Ä–Ω—è—è)** - –∑–∞–Ω—è—Ç–∏—è –≤ –≤—ã—Ö–æ–¥–Ω—ã–µ
   ‚Ä¢ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö
   ‚Ä¢ –û—Ç 55 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä

3Ô∏è‚É£ **–ó–∞–æ—á–Ω–∞—è** - —Å–µ—Å—Å–∏–∏ 2 —Ä–∞–∑–∞ –≤ –≥–æ–¥
   ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
   ‚Ä¢ –û—Ç 35 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä

4Ô∏è‚É£ **–î–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–∞—è** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–Ω–ª–∞–π–Ω
   ‚Ä¢ –ù–µ –Ω—É–∂–Ω–æ –ø—Ä–∏–µ–∑–∂–∞—Ç—å –≤ –ú–æ—Å–∫–≤—É
   ‚Ä¢ –û—Ç 30 000 —Ä—É–±./—Å–µ–º–µ—Å—Ç—Ä

üìû –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: 8 (800) 550-03-63""",

    "–∫–æ–Ω—Ç–∞–∫—Ç—ã": """üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ú–£–ò–í:**

**–¢–µ–ª–µ—Ñ–æ–Ω—ã:**
+7 (495) 500-03-63 (–ú–æ—Å–∫–≤–∞)
8 (800) 550-03-63 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø–æ –†–æ—Å—Å–∏–∏)

**Email:**
pk@muiv.ru

**–ê–¥—Ä–µ—Å:**
115432, –ú–æ—Å–∫–≤–∞
2-–π –ö–æ–∂—É—Ö–æ–≤—Å–∫–∏–π –ø—Ä–æ–µ–∑–¥, 12, —Å—Ç—Ä.1
–ö–∞–±–∏–Ω–µ—Ç 101 (–ü—Ä–∏–µ–º–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è)

**–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:**
–ü–Ω-–ß—Ç: 09:30-18:15
–ü—Ç: 09:30-17:00
–°–±: 10:00-15:00
–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π

**–°–∞–π—Ç:** https://www.muiv.ru
**VK:** vk.com/muiv"""
}

# System Prompt
SYSTEM_PROMPT = """–¢—ã - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ –ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏–º–µ–Ω–∏ –°.–Æ. –í–∏—Ç—Ç–µ (–ú–£–ò–í).

–¢–í–û–Ø –†–û–õ–¨:
- –ü–æ–º–æ–≥–∞—Ç—å –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–∞–º —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏
- –î–∞–≤–∞—Ç—å —Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ë—ã—Ç—å –≤–µ–∂–ª–∏–≤—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º

–ü–†–ê–í–ò–õ–ê:
- –û–±—Ä–∞—â–∞–π—Å—è –Ω–∞ "–≤—ã"
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¢–û–õ–¨–ö–û –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º (2-4 –∞–±–∑–∞—Ü–∞ –º–∞–∫—Å–∏–º—É–º)
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç - —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ –∏ –¥–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π emoji —É–º–µ—Ä–µ–Ω–Ω–æ (üìö üéì üí∞ üìû)
- –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

–ö–û–ù–¢–ê–ö–¢–´ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
üìû 8 (800) 550-03-63 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
‚úâÔ∏è pk@muiv.ru
üåê muiv.ru"""


# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========

def get_main_keyboard():
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìö –î–æ–∫—É–º–µ–Ω—Ç—ã"), KeyboardButton(text="üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å")],
            [KeyboardButton(text="üéì –ë—é–¥–∂–µ—Ç"), KeyboardButton(text="üè† –û–±—â–µ–∂–∏—Ç–∏–µ")],
            [KeyboardButton(text="üìù –ë–µ–∑ –ï–ì–≠"), KeyboardButton(text="üè´ –§–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è")],
            [KeyboardButton(text="üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã"), KeyboardButton(text="‚ùì –ü–æ–º–æ—â—å")]
        ],
        resize_keyboard=True,
        input_field_placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."
    )
    return keyboard


# ========== –§–£–ù–ö–¶–ò–ò ==========

def find_relevant_context(question: str) -> str:
    """–ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º"""
    question_lower = question.lower()
    contexts = []
    
    keywords_map = {
        "–¥–æ–∫—É–º–µ–Ω—Ç—ã": ["–¥–æ–∫—É–º–µ–Ω—Ç", "–Ω—É–∂–Ω", "–ø–æ–¥–∞—Ç—å", "–ø–∞—Å–ø–æ—Ä—Ç", "–∞—Ç—Ç–µ—Å—Ç–∞—Ç"],
        "—Å—Ç–æ–∏–º–æ—Å—Ç—å": ["—Å—Ç–æ–∏–º", "—Ü–µ–Ω–∞", "—Å–∫–æ–ª—å–∫–æ", "–æ–ø–ª–∞—Ç", "–¥–µ–Ω—å–≥"],
        "–±—é–¥–∂–µ—Ç": ["–±—é–¥–∂–µ—Ç", "–±–µ—Å–ø–ª–∞—Ç–Ω", "–∫—Ü–ø", "–º–µ—Å—Ç–∞"],
        "–æ–±—â–µ–∂–∏—Ç–∏–µ": ["–æ–±—â–µ–∂–∏—Ç", "–∂–∏–ª", "–ø—Ä–æ–∂–∏–≤", "–∫–æ–º–Ω–∞—Ç"],
        "–µ–≥—ç": ["–µ–≥—ç", "—ç–∫–∑–∞–º–µ–Ω", "–±–µ–∑ –µ–≥—ç", "–≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω"],
        "—Ñ–æ—Ä–º—ã": ["—Ñ–æ—Ä–º–∞", "–æ—á–Ω", "–∑–∞–æ—á–Ω", "–¥–∏—Å—Ç–∞–Ω—Ü", "–æ–±—É—á–µ–Ω"],
        "–∫–æ–Ω—Ç–∞–∫—Ç—ã": ["–∫–æ–Ω—Ç–∞–∫—Ç", "—Ç–µ–ª–µ—Ñ–æ–Ω", "–∞–¥—Ä–µ—Å", "email", "–∑–≤–æ–Ω–∏—Ç—å"]
    }
    
    # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    for key, keywords in keywords_map.items():
        if any(kw in question_lower for kw in keywords):
            if key in FAQ_BASE:
                contexts.append(FAQ_BASE[key])
    
    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª—É—á–∞–π–Ω—ã—Ö
    if not contexts:
        contexts = list(FAQ_BASE.values())[:3]
    
    return "\n\n---\n\n".join(contexts[:3])


async def get_ai_response(user_id: int, question: str) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç DeepSeek —á–µ—Ä–µ–∑ OpenRouter"""
    try:
        # –ù–∞–π—Ç–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context = find_relevant_context(question)
        
        # –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        history = chat_history.get(user_id, [])
        
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        messages = [
            {"role": "system", "content": SYSTEM_PROMPT}
        ]
        
        # –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        messages.extend(history[-4:])
        
        # –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
        user_message = f"""–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{context}

---

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {question}

–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."""

        messages.append({"role": "user", "content": user_message})
        
        # –ó–∞–ø—Ä–æ—Å –∫ OpenRouter
        logger.info(f"–ó–∞–ø—Ä–æ—Å –∫ {MODEL} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        response = await openai_client.chat.completions.create(
            model=MODEL,
            messages=messages,
            temperature=0.7,
            max_tokens=800
        )
        
        answer = response.choices[0].message.content.strip()
        
        # –û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        if user_id not in chat_history:
            chat_history[user_id] = []
        
        chat_history[user_id].append({"role": "user", "content": question})
        chat_history[user_id].append({"role": "assistant", "content": answer})
        
        # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        if len(chat_history[user_id]) > 10:
            chat_history[user_id] = chat_history[user_id][-10:]
        
        logger.info(f"–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        return answer
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}", exc_info=True)
        return """üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –Ω–∞–ø—Ä—è–º—É—é:
üìû 8 (800) 550-03-63 (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
‚úâÔ∏è pk@muiv.ru"""


# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========

@dp.message(CommandStart())
async def cmd_start(message: Message):
    user_name = message.from_user.first_name
    
    welcome = f"""üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {user_name}!

–Ø –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏ **–ú–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏–º–µ–Ω–∏ –°.–Æ. –í–∏—Ç—Ç–µ** (–ú–£–ò–í).

**–ü–æ–º–æ–≥—É —É–∑–Ω–∞—Ç—å:**
üìö –î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –∏ —Å–∫–∏–¥–∫–∏
üéì –ë—é–¥–∂–µ—Ç–Ω—ã–µ –º–µ—Å—Ç–∞ (–ö–¶–ü)
üè† –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—â–µ–∂–∏—Ç–∏–∏
üìù –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –±–µ–∑ –ï–ì–≠
üè´ –§–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è

**–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–∑ –º–µ–Ω—é –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å!** üëá"""
    
    await message.answer(welcome, reply_markup=get_main_keyboard(), parse_mode="Markdown")
    logger.info(f"–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message.from_user.id} - {user_name}")


@dp.message(Command("help"))
async def cmd_help(message: Message):
    help_text = """ü§ñ **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:**

1Ô∏è‚É£ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–æ–º
2Ô∏è‚É£ –ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ
3Ô∏è‚É£ –Ø –æ—Ç–≤–µ—á—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ú–£–ò–í

**–ö–æ–º–∞–Ω–¥—ã:**
/start - –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/clear - –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞

üìû –°–≤—è–∑—å: 8 (800) 550-03-63
‚úâÔ∏è Email: pk@muiv.ru"""
    
    await message.answer(help_text, parse_mode="Markdown")


@dp.message(Command("clear"))
async def cmd_clear(message: Message):
    user_id = message.from_user.id
    if user_id in chat_history:
        del chat_history[user_id]
    await message.answer("‚úÖ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞!")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
@dp.message(F.text == "üìö –î–æ–∫—É–º–µ–Ω—Ç—ã")
async def btn_docs(message: Message):
    await message.answer(FAQ_BASE["–¥–æ–∫—É–º–µ–Ω—Ç—ã"], parse_mode="Markdown")

@dp.message(F.text == "üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å")
async def btn_price(message: Message):
    await message.answer(FAQ_BASE["—Å—Ç–æ–∏–º–æ—Å—Ç—å"], parse_mode="Markdown")

@dp.message(F.text == "üéì –ë—é–¥–∂–µ—Ç")
async def btn_budget(message: Message):
    await message.answer(FAQ_BASE["–±—é–¥–∂–µ—Ç"], parse_mode="Markdown")

@dp.message(F.text == "üè† –û–±—â–µ–∂–∏—Ç–∏–µ")
async def btn_dorm(message: Message):
    await message.answer(FAQ_BASE["–æ–±—â–µ–∂–∏—Ç–∏–µ"], parse_mode="Markdown")

@dp.message(F.text == "üìù –ë–µ–∑ –ï–ì–≠")
async def btn_ege(message: Message):
    await message.answer(FAQ_BASE["–µ–≥—ç"], parse_mode="Markdown")

@dp.message(F.text == "üè´ –§–æ—Ä–º—ã –æ–±—É—á–µ–Ω–∏—è")
async def btn_forms(message: Message):
    await message.answer(FAQ_BASE["—Ñ–æ—Ä–º—ã"], parse_mode="Markdown")

@dp.message(F.text == "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã")
async def btn_contacts(message: Message):
    await message.answer(FAQ_BASE["–∫–æ–Ω—Ç–∞–∫—Ç—ã"], parse_mode="Markdown")

@dp.message(F.text == "‚ùì –ü–æ–º–æ—â—å")
async def btn_help(message: Message):
    await cmd_help(message)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@dp.message(F.text)
async def handle_text(message: Message):
    user_id = message.from_user.id
    question = message.text
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    text_lower = question.lower()
    if any(word in text_lower for word in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "–¥–æ–±—Ä—ã–π"]):
        await message.answer("üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≤ –ú–£–ò–í!", 
                           reply_markup=get_main_keyboard())
        return
    
    if any(word in text_lower for word in ["—Å–ø–∞—Å–∏–±–æ", "–±–ª–∞–≥–æ–¥–∞—Ä—é"]):
        await message.answer("üòä –†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å, –µ—Å–ª–∏ –±—É–¥—É—Ç –µ—â–µ –≤–æ–ø—Ä–æ—Å—ã!")
        return
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
    await bot.send_chat_action(message.chat.id, "typing")
    
    # –ü–æ–ª—É—á–∏—Ç—å AI –æ—Ç–≤–µ—Ç
    logger.info(f"–í–æ–ø—Ä–æ—Å –æ—Ç {user_id}: {question[:50]}...")
    answer = await get_ai_response(user_id, question)
    
    await message.answer(answer, parse_mode="Markdown", reply_markup=get_main_keyboard())


# ========== –ó–ê–ü–£–°–ö ==========

async def on_startup():
    logger.info("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    logger.info(f"üì° –ú–æ–¥–µ–ª—å: {MODEL}")
    logger.info(f"üîó API: {BASE_URL}")
    logger.info("‚úÖ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")


async def main():
    dp.startup.register(on_startup)
    await bot.delete_webhook(drop_pending_updates=True)
    logger.info("üöÄ –ù–∞—á–∏–Ω–∞—é polling...")
    await dp.start_polling(bot)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("‚å®Ô∏è –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.critical(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)